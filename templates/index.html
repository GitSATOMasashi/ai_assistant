<!DOCTYPE html>
<html>
    <head>
        <title>講座生成ツール | スキルプラス</title>
        <link rel="icon" type="image/png" href="https://utagesystem.s3.ap-northeast-1.amazonaws.com/GYbKT7Y9d0eR/HJ0dPMDAxFWVgbt4WpedkCyrlU6fDnLSKMS0nWyd.png">
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            primary: {
                                DEFAULT: '#14106d',  // 基本のプライマリーカラー
                                light: '#1d187f',    // ホバー時などに使用する明るめの色
                                dark: '#0c0945',     // アクティブ時などに使用する暗めの色
                                50: '#eeeeff',       // 薄い背景などに使用
                                100: '#e0e0ff'       // 選択状態の背景などに使用
                            }
                        }
                    }
                }
            }
        </script>
        <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
    </head>
    <body class="bg-white">
        <!-- ヘッダーを追加 -->
        <header class="fixed top-0 left-0 right-0 h-14 border-b z-50 flex items-center bg-gradient-to-r from-[#14106d] to-[#2d26b4]">
            <div class="w-72 px-4 border-r h-full flex items-center justify-between border-white/10">
                <img 
                    src="https://utagesystem.s3.ap-northeast-1.amazonaws.com/GYbKT7Y9d0eR/lWxuhEMydgkvCjlDrIz6WVN0inLMiTfDWoT8l3y0.png" 
                    alt="講義生成ツール" 
                    class="w-auto object-contain"
                    style="height: 20px; padding-left: 30px;"
                >
                <span class="text-white">|</span>
                <img 
                    src="https://utagesystem.s3.ap-northeast-1.amazonaws.com/GYbKT7Y9d0eR/site/hmVD4xF1NEqp7KMtARVEmpfW5wJAGEqmrWiqS1Qa.png" 
                    alt="スキルプラス ロゴ" 
                    class="w-auto object-contain"
                    style="height: 20px; padding-right: 30px; padding-left: 5px;"
                >
            </div>
            <div class="flex-1 px-6 flex justify-between items-center">
                <div class="text-sm text-white/70">
                    <!-- 必要に応じて追加のヘッダー情報 -->
                </div>
                <div class="flex items-center gap-4">
                    <button 
                        onclick="resetTokens()" 
                        class="dev-only px-3 py-1 text-sm text-white/80 hover:text-white border border-white/20 rounded hover:bg-white/10 transition-colors"
                        title="トークン数をリセットします"
                    >
                        リセット
                    </button>
                    <div class="text-sm text-white/90">
                        今月の残りトークン数: <span id="remainingTokens">1,000,000</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- メインコンテンツのラッパー -->
        <div class="flex h-screen pt-14">
            <!-- サイドバー: h-screenからpt-14を引いた高さにする -->
            <div class="w-72 border-r bg-gray-50 overflow-y-auto" style="height: calc(100vh - 3.5rem);">
                <!-- 新しいトークボタンを固定表示 -->
                <div class="sticky top-0 p-4 bg-gray-50 border-b z-10">
                    <button onclick="createNewChat()" class="new-chat-button w-full flex items-center justify-center bg-gray-50 text-primary border-2 border-primary hover:bg-primary hover:text-white px-4 py-2 transition-colors rounded-[25px]">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        新しいトーク
                    </button>
                </div>
                
                <!-- チャットリスト -->
                <div class="px-4">
                    <!-- ピン留めしたトーク -->
                    <div class="chat-section">
                        <h3 class="chat-section-title">ピン留め</h3>
                        <div id="pinnedChats" class="chat-list"></div>
                    </div>

                    <!-- すべてのトーク -->
                    <div class="chat-section">
                        <h3 class="chat-section-title">すべてのトーク</h3>
                        <div id="allChats" class="chat-list"></div>
                    </div>
                </div>
            </div>

            <!-- メインチャットエリア -->
            <div class="flex-1 flex flex-col">
                <div class="flex-1 overflow-y-auto p-4" id="messages">
                    <!-- ローディング表示用のHTML -->
                    <div id="loadingMessage" class="hidden">
                        <div class="flex justify-start mb-4">
                            <div class="bg-gray-100 rounded-lg px-4 py-2 max-w-[70%] flex items-center">
                                <div class="typing-indicator">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                                <span class="ml-2">
                                    応答を生成中...<br>
                                    <span class="text-sm text-gray-500">応答までに最大で60〜120秒ほどかかる場合があります。</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="border-t p-4 flex items-start">
                    <textarea 
                        id="messageInput"
                        class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none overflow-y-auto"
                        placeholder="メッセージを入力...(Shift + Enter で送信)"
                        rows="1"
                        style="min-height: 44px;"
                    ></textarea>
                    <button 
                        id="sendButton" 
                        onclick="sendMessage()" 
                        class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/80 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        送信
                    </button>
                </div>
            </div>
        </div>

        <!-- ボット選択モーダル -->
        <div id="botSelector" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">チャットモードを選択</h2>
                    <button onclick="closeBotSelector()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="space-y-3">
                    <button onclick="selectBot('bot1', '目次作成モード')" class="w-full p-4 text-left border rounded-lg hover:bg-gray-50">
                        <h3 class="font-medium">目次作成モード</h3>
                        <p class="text-sm text-gray-500">講座全体の目次を作成します。</p>
                    </button>
                    <button onclick="selectBot('bot2', '講義作成モード')" class="w-full p-4 text-left border rounded-lg hover:bg-gray-50">
                        <h3 class="font-medium">講義作成モード</h3>
                        <p class="text-sm text-gray-500">講義ページの内容を作成します。</p>
                    </button>
                    <button onclick="selectBot('bot3', 'スライド作成モード')" class="w-full p-4 text-left border rounded-lg hover:bg-gray-50">
                        <h3 class="font-medium">スライド作成モード</h3>
                        <p class="text-sm text-gray-500">講義スライドを作成します。</p>
                    </button>
                    <button onclick="selectBot('bot4', 'スライド埋め込みコード作成')" class="w-full p-4 text-left border rounded-lg hover:bg-gray-50">
                        <h3 class="font-medium">スライド埋め込みコード作成</h3>
                        <p class="text-sm text-gray-500">講義ページにスライドを埋め込むためのコードを作成します。</p>
                    </button>
                </div>
            </div>
        </div>

        <!-- トークのメニューモーダル -->
        <div id="chatMenu" class="chat-menu hidden">
            <button onclick="editChatTitle()" class="chat-menu-item">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                タイトルの編集
            </button>
            <button onclick="togglePinChat()" class="chat-menu-item">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                </svg>
                ピン留め
            </button>
            <button onclick="deleteChat()" class="chat-menu-item text-red-600">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                削除
            </button>
        </div>

        <!-- モーダルを追加（bodyの最後） -->
        <div id="tokenLimitModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-md mx-4 relative">
                <div class="absolute top-4 right-4">
                    <button onclick="closeTokenLimitModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div id="tokenLimitModalContent" class="whitespace-pre-line text-gray-700"></div>
            </div>
        </div>

        <!-- エラーモーダル -->
        <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-red-600">500エラー</h2>
                    <button onclick="closeErrorModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="space-y-4">
                    <p id="errorMessage" class="text-gray-600"></p>
                    <div class="text-sm text-gray-500">
                        <p class="font-medium mb-2">考えられる原因:</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>応答生成のタイムアウト</li>
                            <li>サーバーの一時的な問題</li>
                            <li>トークン制限の超過</li>
                        </ul>
                    </div>
                    <div class="text-sm text-gray-500">
                        <p class="font-medium mb-2">対処方法:</p>
                        <ul class="list-disc pl-5 space-y-1">
                            <li>しばらく待ってから再度お試しください</li>
                            <li>メッセージを短く分けて送信してみてください</li>
                            <li>ブラウザをリロードしてください</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function canSendMessage() {
                const remainingTokens = parseInt(document.getElementById('remainingTokens').textContent);
                if (remainingTokens <= 0) {
                    showTokenLimitModal(getTokenLimitMessage());
                    return false;
                }
                return true;
            }
            
            // チャットの状態管理
            let chats = [];
            let currentChatId = null;
            let currentBot = null;

            // トークン管理のクラスを修正
            class TokenManager {
                constructor(monthlyLimit = 1000000) {  // 変更: 月間100万トークン
                    this.monthlyLimit = monthlyLimit;
                    this.loadFromStorage();
                }

                loadFromStorage() {
                    const stored = localStorage.getItem('tokenUsage');
                    if (stored) {
                        const data = JSON.parse(stored);
                        // 月が変わっていたらリセット
                        const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM形式
                        if (data.month === currentMonth) {
                            this.usedTokens = data.usedTokens;
                            this.updateDisplay();
                            return;
                        }
                    }
                    // 新しい月、またはデータがない場合
                    this.resetTokens();
                }

                saveToStorage() {
                    const data = {
                        month: new Date().toISOString().slice(0, 7),  // YYYY-MM形式
                        usedTokens: this.usedTokens
                    };
                    localStorage.setItem('tokenUsage', JSON.stringify(data));
                }

                resetTokens() {
                    this.usedTokens = 0;
                    this.saveToStorage();
                    this.updateDisplay();
                }

                getRemainingTokens() {
                    return this.monthlyLimit - this.usedTokens;
                }

                useTokens(count) {
                    this.usedTokens += count;
                    this.saveToStorage();
                    this.updateDisplay();
                    return this.getRemainingTokens();
                }

                updateDisplay() {
                    document.getElementById('remainingTokens').textContent = this.getRemainingTokens();
                }

                // トークン計算をサーバーに委譲
                async calculateTokens(text) {
                    try {
                        const response = await fetch('/calculate_tokens', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                text: text,
                                user_id: 'default_user'  // 必要に応じてユーザーIDを設定
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error('トークン計算に失敗しました');
                        }
                        
                        const data = await response.json();
                        return data.tokens;
                    } catch (error) {
                        console.error('トークン計算エラー:', error);
                        return this.fallbackCalculateTokens(text);
                    }
                }

                // フォールバック用のトークン計算（クライアントサイド）
                fallbackCalculateTokens(text) {
                    const japaneseChars = (text.match(/[\u3000-\u303f\u3040-\u309f\u30a0-\u30ff\u4e00-\u9faf\u3400-\u4dbf]/g) || []).length;
                    const otherChars = (text.match(/[a-zA-Z0-9\s\W]/g) || []).length;
                    return Math.max(1, Math.ceil(japaneseChars * 2.5 + otherChars * 0.5));
                }
            }

            // トークンマネージャーのインスタンスを作成
            const tokenManager = new TokenManager(1000000);  // 100万トークンで初期化

            // LocalStorageからチャット履歴を読み込む
            function loadChats() {
                const savedChats = localStorage.getItem('chats');
                if (savedChats) {
                    chats = JSON.parse(savedChats);
                    updateChatList();
                }
            }

            // チャット履歴を保存
            function saveChats() {
                localStorage.setItem('chats', JSON.stringify(chats));
            }

            // 新しいトークを作成
            function createNewChat() {
                const newChat = {
                    id: Date.now().toString(),
                    title: '※チャットモード未選択',
                    messages: [],
                    pinned: false,
                    bot: null,
                    conversation_id: null  // 各トーク固有の会話ID
                };
                
                chats.push(newChat);
                currentChatId = newChat.id;
                currentBot = null;
                
                displayMessages([]);  // メッセージをクリア
                updateChatList();
                saveChats();
                openBotSelector();  // ボット選択モーダルを開く
            }

            // ボットごとの初期メッセージを定義
            const BOT_INITIAL_MESSAGES = {
                bot1: {
                    title: '目次作成モード',
                    message: '作成する講座のタイトルと目的を入力してください。'
                },
                bot2: {
                    title: '講義作成モード',
                    message: '作成した目次をそのまま入力してください。'
                },
                bot3: {
                    title: 'スライド作成モード',
                    message: '講義のHTMLコードを入力してください。'
                },
                bot4: {
                    title: 'スライド埋め込みコード作成',
                    message: 'Googleドライブの共有リンクを入力してください。'
                }
            };

            // チャットボットを選択して紐づけ
            function selectBot(botId, botTitle) {
                const chat = chats.find(c => c.id === currentChatId);
                if (!chat) return;
                
                // ボット情報を更新
                chat.bot = botId;
                chat.title = BOT_INITIAL_MESSAGES[botId].title;
                currentBot = botId;
                
                // ボットごとの初期メッセージを追加
                chat.messages.push({
                    role: 'assistant',
                    content: BOT_INITIAL_MESSAGES[botId].message
                });
                
                displayMessages(chat.messages);
                updateChatList();
                saveChats();
                closeBotSelector();
            }

            function updateChatList() {
                const pinnedChats = document.getElementById('pinnedChats');
                const allChats = document.getElementById('allChats');
                
                pinnedChats.innerHTML = '';
                allChats.innerHTML = '';
                
                // 作成日時の新しい順にソート
                const sortedChats = [...chats].sort((a, b) => b.id - a.id);
                
                sortedChats.forEach(chat => {
                    const chatElement = createChatElement(chat);
                    if (chat.pinned) {
                        pinnedChats.appendChild(chatElement);
                    } else {
                        allChats.appendChild(chatElement);
                    }
                });
            }

            function createChatElement(chat) {
                const div = document.createElement('div');
                div.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="chat-title">${chat.title}</span>
                        <button onclick="showChatMenu(event, '${chat.id}')" class="chat-menu-button">
                            •••
                        </button>
                    </div>
                `;
                div.onclick = () => selectChat(chat.id);
                return div;
            }

            function selectChat(chatId) {
                currentChatId = chatId;
                const chat = chats.find(c => c.id === chatId);
                currentBot = chat.bot;
                updateChatList();
                displayMessages(chat.messages);
            }

            function displayMessages(messages) {
                const messagesDiv = document.getElementById('messages');
                const loadingMessage = document.getElementById('loadingMessage');
                const loading = loadingMessage.cloneNode(true);
                
                messagesDiv.innerHTML = '';
                
                messages.forEach(message => {
                    if (!message?.role || !message?.content) {
                        console.warn('Invalid message:', message);
                        return;
                    }

                    const messageDiv = document.createElement('div');
                    messageDiv.className = `flex ${message.role === 'user' ? 'justify-end' : 'justify-start'} py-2`;
                    
                    let content = message.content;
                    
                    // まず全体をHTMLエスケープ
                    content = content
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');

                    // コードブロックを装飾（言語識別子を削除）
                    content = content.replace(/```[\w]*\n([\s\S]*?)```/g, (match, code) => {
                        return `<div class="code-block"><div class="code-block-header"><span>コードブロック</span><button class="code-block-copy" onclick="copyCodeBlock(event, this)">コピー</button></div><div class="code-block-content">${code}</div></div>`;
                    });

                    const messageClass = message.role === 'user' 
                        ? 'bg-primary text-white' 
                        : message.role === 'error' 
                            ? 'bg-red-100 text-red-600'
                            : 'bg-gray-100';

                    messageDiv.innerHTML = `<div class="message-container relative group max-w-[70%]"><div class="${messageClass} rounded-lg px-4 py-2 w-full whitespace-pre-wrap break-words">${content}</div></div>`;
                    
                    messagesDiv.appendChild(messageDiv);
                });
                
                // ローディング要素を再追加
                messagesDiv.appendChild(loading);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            function showChatMenu(event, chatId) {
                event.stopPropagation();
                const menu = document.getElementById('chatMenu');
                menu.classList.remove('hidden');
                menu.style.top = `${event.pageY}px`;
                menu.style.left = `${event.pageX}px`;
                currentChatId = chatId;
            }

            function editChatTitle() {
                const chat = chats.find(c => c.id === currentChatId);
                const newTitle = prompt('新しいタイトルを入力してください', chat.title);
                if (newTitle) {
                    chat.title = newTitle;
                    updateChatList();
                    saveChats();
                    displayMessages(chat.messages);  // 現在のメッセージを再表示
                }
                document.getElementById('chatMenu').classList.add('hidden');
            }

            function togglePinChat() {
                const chat = chats.find(c => c.id === currentChatId);
                chat.pinned = !chat.pinned;
                updateChatList();
                saveChats();
                displayMessages(chat.messages);  // 現在のメッセージを再表示
                document.getElementById('chatMenu').classList.add('hidden');
            }

            function deleteChat() {
                if (confirm('このトークを削除してもよろしいですか？')) {
                    chats = chats.filter(c => c.id !== currentChatId);
                    
                    // 他のトークがある場合は最新のトークを選択
                    if (chats.length > 0) {
                        const latestChat = chats[chats.length - 1];
                        currentChatId = latestChat.id;
                        currentBot = latestChat.bot;
                        displayMessages(latestChat.messages);
                    } else {
                        // トークがない場合は新しいトークを作成
                        createNewChat();
                    }
                    
                    updateChatList();
                    saveChats();
                }
                document.getElementById('chatMenu').classList.add('hidden');
            }

            // ボット選択関連
            function openBotSelector() {
                document.getElementById('botSelector').classList.remove('hidden');
            }

            function closeBotSelector() {
                document.getElementById('botSelector').classList.add('hidden');
            }

            async function sendMessage() {
                // 先頭でトークン制限をチェック
                if (!canSendMessage()) {
                    showTokenLimitModal(getTokenLimitMessage());
                    return;
                }

                // ボット選択チェックは維持
                if (!currentBot) {
                    showBotSelector();
                    return;
                }
                
                const input = document.getElementById('messageInput');
                const message = input.value.trim();
                if (!message) return;

                try {
                    // 入力メッセージのトークン数を計算
                    const response = await fetch('/calculate_tokens', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ text: message })
                    });
                    
                    const tokenData = await response.json();
                    
                    // 送信時のログ
                    console.log(`
=== 送信時のトークン状況 ===
今月の使用可能トークン（初期値）：1,000,000
このメッセージで消費したトークン：${tokenData.tokens}
今月の累積消費トークン：${1000000 - tokenData.remaining_tokens + tokenData.tokens}
今月の使用可能トークン：${tokenData.remaining_tokens - tokenData.tokens}
===========================`);

                    // トークン制限チェック
                    if (tokenData.remaining_tokens <= 0) {  // 残りトークンが0以下の場合
                        showTokenLimitModal(getTokenLimitMessage());
                        return;
                    } else if (tokenData.tokens > tokenData.remaining_tokens) {  // 必要なトークン数が残りトークン数を超える場合
                        showTokenLimitModal(getTokenLimitMessage());
                        return;
                    }

                    // 入力トークンを消費（ユーザー送信時）
                    tokenManager.useTokens(tokenData.tokens);

                    const chat = chats.find(c => c.id === currentChatId);
                    chat.messages.push({
                        role: 'user',
                        content: message
                    });
                    
                    displayMessages(chat.messages);
                    input.value = '';

                    // ローディング表示
                    const loadingMessage = document.getElementById('loadingMessage');
                    loadingMessage.classList.remove('hidden');

                    const apiResponse = await fetch(`/chat/${currentBot}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            conversation_id: chat.conversation_id  // 各トーク固有の会話IDを使用
                        })
                    });

                    if (!apiResponse.ok) {
                        let errorMessage = 'エラーが発生しました。';
                        if (apiResponse.status === 500) {
                            errorMessage = `
【500エラー】
申し訳ありません。サーバーでエラーが発生しました。

考えられる原因:
1. 応答生成のタイムアウト
2. サーバーの一時的な問題
3. トークン制限の超過

対処方法:
1. しばらく待ってから再度お試しください
2. メッセージを短く分けて送信してみてください
3. ブラウザをリロードしてください

エラーが続く場合は、サポートまでご連絡ください。`;
                        }
                        throw new Error(errorMessage);
                    }

                    const data = await apiResponse.json();
                    loadingMessage.classList.add('hidden');

                    // AIの応答を追加
                    chat.messages.push({
                        role: 'assistant',
                        content: data.answer
                    });

                    // AIの応答を受信後、応答のトークン数も計算
                    const outputTokenResponse = await fetch('/calculate_tokens', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ text: data.answer })
                    });
                    
                    const outputTokenData = await outputTokenResponse.json();
                    
                    // 受信時のログ
                    console.log(`
=== 受信時のトークン状況 ===
今月の使用可能トークン（初期値）：1,000,000
このメッセージで消費したトークン：${outputTokenData.tokens}
今月の累積消費トークン：${1000000 - outputTokenData.remaining_tokens + outputTokenData.tokens}
今月の使用可能トークン：${outputTokenData.remaining_tokens - outputTokenData.tokens}
===========================`);

                    // レスポンス後のトークン制限チェック
                    const remainingTokens = parseInt(document.getElementById('remainingTokens').textContent);
                    if (remainingTokens <= 0) {
                        showTokenLimitModal(getTokenLimitMessage());
                        return;
                    }

                    // 出力トークンを計算（サーバーサイド）
                    const outputTokens = await tokenManager.calculateTokens(data.answer);
                    tokenManager.useTokens(outputTokens);
                    
                    displayMessages(chat.messages);
                    saveChats();
                    
                    // 新しい会話IDを保存
                    if (data.conversation_id) {
                        chat.conversation_id = data.conversation_id;
                        saveChats();  // LocalStorageに保存
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    loadingMessage.classList.add('hidden');
                    
                    // 500エラーの場合、モーダルを表示
                    if (error.message.includes('【500エラー】')) {
                        showErrorModal('申し訳ありません。サーバーでエラーが発生しました。');
                    }
                    
                    chat.messages.push({
                        role: 'error',
                        content: error.message || 'エラーが発生しました。もう一度お試しください。'
                    });
                    displayMessages(chat.messages);
                }
            }

            // テキストエリアの高さを自動調整する関数を修正
            function adjustTextareaHeight(textarea) {
                // 一時的に高さをリセット
                textarea.style.height = 'auto';
                
                // スクロール高さと最大高さを比較
                const newHeight = Math.min(textarea.scrollHeight, 200);
                textarea.style.height = newHeight + 'px';
                
                // 最大高さを超えた場合、スクロールを有効化
                textarea.style.overflowY = textarea.scrollHeight > 200 ? 'auto' : 'hidden';
            }

            // テキストエリアのイベントリスナーを設定
            document.getElementById('messageInput').addEventListener('input', function(e) {
                adjustTextareaHeight(this);
            });

            // キーイベントの処理
            document.getElementById('messageInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    if (e.shiftKey) {
                        // Shift + Enter が押された場合は送信
                        e.preventDefault();
                        if (!canSendMessage()) {
                            showTokenLimitModal(getTokenLimitMessage());
                            return;
                        }
                        sendMessage();
                    }
                    // 通常のEnterは改行を許可（デフォルトの動作）
                    adjustTextareaHeight(this);
                }
            });

            // クリック以外でメニューを閉じる
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('chatMenu');
                if (!menu.contains(e.target) && !e.target.classList.contains('chat-menu-button')) {
                    menu.classList.add('hidden');
                }
            });

            // トークンのリセット（デモ用）
            function resetTokens() {
                tokenManager.resetTokens();
            }

            // 初期表示時の処理だけを追加
            document.addEventListener('DOMContentLoaded', () => {
                loadChats();
                
                if (chats.length === 0) {
                    // トークが1つもない場合は、ボット選択モーダルを表示
                    createNewChat();
                } else {
                    // 最新のトークを選択（配列の最後の要素）
                    const latestChat = chats[chats.length - 1];
                    currentChatId = latestChat.id;
                    currentBot = latestChat.bot;
                    
                    // 最新のトークを表示
                    displayMessages(latestChat.messages);
                    
                    // サイドバーのトーク一覧を更新
                    updateChatList();
                }
            });

            // チャットをクリアする時に会話IDもリセット
            function clearChat() {
                chatMessages.innerHTML = '';
                currentConversationId = null;
            }

            // トークン数に基づいて送信ボタンの状態を更新する関数
            function updateSendButtonState() {
                const remainingTokens = parseInt(document.getElementById('remainingTokens').textContent);
                const sendButton = document.getElementById('sendButton');
                
                if (!canSendMessage()) {
                    sendButton.disabled = true;
                    sendButton.title = getTokenLimitMessage().split('\n')[0];  // タイトルには1行目だけ表示
                } else {
                    sendButton.disabled = false;
                    sendButton.removeAttribute('title');
                }
            }

            // ページ読み込み時
            document.addEventListener('DOMContentLoaded', updateSendButtonState);

            // トークン計算の関数内で
            async function calculateTokens(message) {
                // ... 既存のコード ...
                const response = await fetch('/calculate_tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: message, user_id: userId })
                });
                const tokenData = await response.json();
                document.getElementById('remainingTokens').textContent = tokenData.remaining_tokens;
                updateSendButtonState();  // ここで更新
                return tokenData;
            }

            // メッセージ送信後のレスポンス処理時
            async function handleResponse(response) {
                // ... 既存のコード ...
                const remainingTokens = parseInt(document.getElementById('remainingTokens').textContent) - outputTokenData.tokens;
                document.getElementById('remainingTokens').textContent = remainingTokens;
                updateSendButtonState();  // ここで更新
            }

            // トークン制限メッセージを生成する関数を修正
            function getTokenLimitMessage() {
                const totalTokens = 1000000;  // 月間上限トークン数
                const remainingTokens = parseInt(document.getElementById('remainingTokens').textContent);
                const usedTokens = totalTokens - remainingTokens;
                const nextMonth = new Date();
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                nextMonth.setDate(1);
                nextMonth.setHours(0, 0, 0, 0);
                
                return `【トークン制限のお知らせ】

トークンの今月分使用枠を使い切りました。

■ 次回利用可能時間
${nextMonth.getFullYear()}年${nextMonth.getMonth() + 1}月1日 0:00から

■ 現在の使用状況
今月の使用量: ${usedTokens.toLocaleString()} トークン
月間上限: ${totalTokens.toLocaleString()} トークン

■ ご利用再開までの選択肢
1. 月初の自動リセットをお待ちください
2. トークン使用枠の増枠をご検討ください
   → サポートLINEにてご相談を承ります。
   「講座生成ツールのトークン増枠」とお伝えください。

ご不便をおかけし申し訳ございません。
引き続きのご利用をお待ちしております。`;
            }

            // モーダル表示関数
            function showTokenLimitModal(message) {
                const modal = document.getElementById('tokenLimitModal');
                const content = document.getElementById('tokenLimitModalContent');
                content.textContent = message;
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }

            // モーダルを閉じる関数
            function closeTokenLimitModal() {
                const modal = document.getElementById('tokenLimitModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            // エラーモーダルを制御する関数を追加
            function showErrorModal(message) {
                const modal = document.getElementById('errorModal');
                const messageElement = document.getElementById('errorMessage');
                if (modal && messageElement) {
                    messageElement.textContent = message;
                    modal.classList.remove('hidden');
                } else {
                    console.error('Error modal elements not found');
                }
            }

            // エラーモーダルを閉じる関数を追加
            function closeErrorModal() {
                const modal = document.getElementById('errorModal');
                modal.classList.add('hidden');
            }

            // エラー発生時の処理
            function handleError(error) {
                console.error('Error:', error);
                showErrorModal('申し訳ありません。サーバーでエラーが発生しました。');
                // 既存のエラー処理も維持
                appendErrorMessage('エラーが発生しました。しばらく待ってから再度お試しください。');
            }

            function appendMessage(role, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.innerHTML = content;
                
                // コードブロックのスタイリング
                if (content.includes('```')) {
                    contentDiv.classList.add('code-block');
                }
                
                messageDiv.appendChild(contentDiv);
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function copyCodeBlock(event, button) {
                // イベントの伝播を停止
                event.stopPropagation();
                
                const codeBlock = button.closest('.code-block');
                const code = codeBlock.querySelector('.code-block-content').innerText;
                
                navigator.clipboard.writeText(code).then(() => {
                    const originalText = button.innerText;
                    button.innerText = '完了';
                    button.disabled = true;
                    
                    setTimeout(() => {
                        button.innerText = originalText;
                        button.disabled = false;
                    }, 2000);
                }).catch(err => {
                    console.error('コピーに失敗しました:', err);
                    button.innerText = 'コピー失敗';
                    
                    setTimeout(() => {
                        button.innerText = 'コピー';
                        button.disabled = false;
                    }, 2000);
                });
            }
        </script>
    </body>
</html>
