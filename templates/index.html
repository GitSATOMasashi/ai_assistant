<!DOCTYPE html>
<html>
    <head>
        <title>AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
    </head>
    <body class="bg-white">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <div class="flex h-screen">
            <div class="w-72 border-r bg-gray-50">
                <div class="p-4">
                    <button onclick="createNewChat()" class="new-chat-button">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        æ–°ã—ã„ãƒˆãƒ¼ã‚¯
                    </button>
                </div>
                
                <!-- ãƒ”ãƒ³ç•™ã‚ã—ãŸãƒˆãƒ¼ã‚¯ -->
                <div class="chat-section">
                    <h3 class="chat-section-title">ğŸ“Œ ãƒ”ãƒ³ç•™ã‚</h3>
                    <div id="pinnedChats" class="chat-list"></div>
                </div>

                <!-- ã™ã¹ã¦ã®ãƒˆãƒ¼ã‚¯ -->
                <div class="chat-section">
                    <h3 class="chat-section-title">ğŸ’¬ ã™ã¹ã¦ã®ãƒˆãƒ¼ã‚¯</h3>
                    <div id="allChats" class="chat-list"></div>
                </div>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
            <div class="flex-1 flex flex-col">
                <div class="p-4 border-b">
                    <div class="text-sm text-gray-500 text-right">
                        æ®‹ã‚Šãƒˆãƒ¼ã‚¯ãƒ³: <span id="remainingTokens">2000</span>
                        <button onclick="resetTokens()" class="ml-2 text-blue-500 hover:text-blue-600">ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-4" id="messages">
                    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºç”¨ã®HTML -->
                    <div id="loadingMessage" class="hidden">
                        <div class="flex justify-start mb-4">
                            <div class="bg-gray-100 rounded-lg px-4 py-2 max-w-[70%] flex items-center">
                                <div class="typing-indicator">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                                <span class="ml-2">å¿œç­”ã‚’ç”Ÿæˆä¸­...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="border-t p-4">
                    <div class="flex space-x-2">
                        <input 
                            type="text" 
                            id="messageInput"
                            class="flex-1 border rounded-lg px-4 py-2"
                            placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...(Shift + Enter ã§é€ä¿¡)"
                        >
                        <button 
                            onclick="sendMessage()"
                            class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600"
                        >
                            é€ä¿¡
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒœãƒƒãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="botSelector" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚’é¸æŠ</h2>
                    <button onclick="closeBotSelector()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="space-y-3">
                    <button onclick="selectBot('bot1')" class="w-full p-4 text-left border rounded-lg hover:bg-gray-50">
                        <h3 class="font-medium">ä¸€èˆ¬çš„ãªè³ªå•</h3>
                        <p class="text-sm text-gray-500">æ§˜ã€…ãªè³ªå•ã«ç­”ãˆã¾ã™</p>
                    </button>
                    <button onclick="selectBot('bot2')" class="w-full p-4 text-left border rounded-lg hover:bg-gray-50">
                        <h3 class="font-medium">ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                        <p class="text-sm text-gray-500">ã‚³ãƒ¼ãƒ‰ã®æ”¹å–„ææ¡ˆã‚’è¡Œã„ã¾ã™</p>
                    </button>
                    <button onclick="selectBot('bot3')" class="w-full p-4 text-left border rounded-lg hover:bg-gray-50">
                        <h3 class="font-medium">ãƒ“ã‚¸ãƒã‚¹ç›¸è«‡</h3>
                        <p class="text-sm text-gray-500">ãƒ“ã‚¸ãƒã‚¹ã«é–¢ã™ã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›</p>
                    </button>
                </div>
            </div>
        </div>

        <!-- ãƒˆãƒ¼ã‚¯ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="chatMenu" class="chat-menu hidden">
            <button onclick="editChatTitle()" class="chat-menu-item">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                ã‚¿ã‚¤ãƒˆãƒ«ã®ç·¨é›†
            </button>
            <button onclick="togglePinChat()" class="chat-menu-item">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
                </svg>
                ãƒ”ãƒ³ç•™ã‚
            </button>
            <button onclick="deleteChat()" class="chat-menu-item text-red-600">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                å‰Šé™¤
            </button>
        </div>

        <script>
            // ãƒãƒ£ãƒƒãƒˆã®çŠ¶æ…‹ç®¡ç†
            let chats = [];
            let currentChatId = null;
            let currentBot = null;

            // ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã®ã‚¯ãƒ©ã‚¹
            class TokenManager {
                constructor(dailyLimit = 2000) {
                    this.dailyLimit = dailyLimit;
                    this.loadFromStorage();
                }

                loadFromStorage() {
                    const stored = localStorage.getItem('tokenUsage');
                    if (stored) {
                        const data = JSON.parse(stored);
                        // æ—¥ä»˜ãŒå¤‰ã‚ã£ã¦ã„ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
                        const today = new Date().toDateString();
                        if (data.date === today) {
                            this.usedTokens = data.usedTokens;
                            this.updateDisplay();
                            return;
                        }
                    }
                    // æ–°ã—ã„æ—¥ã€ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
                    this.resetTokens();
                }

                saveToStorage() {
                    const data = {
                        date: new Date().toDateString(),
                        usedTokens: this.usedTokens
                    };
                    localStorage.setItem('tokenUsage', JSON.stringify(data));
                }

                resetTokens() {
                    this.usedTokens = 0;
                    this.saveToStorage();
                    this.updateDisplay();
                }

                getRemainingTokens() {
                    return this.dailyLimit - this.usedTokens;
                }

                useTokens(count) {
                    this.usedTokens += count;
                    this.saveToStorage();
                    this.updateDisplay();
                    return this.getRemainingTokens();
                }

                updateDisplay() {
                    document.getElementById('remainingTokens').textContent = this.getRemainingTokens();
                }
            }

            // ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
            const tokenManager = new TokenManager(2000);

            // LocalStorageã‹ã‚‰ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’èª­ã¿è¾¼ã‚€
            function loadChats() {
                const savedChats = localStorage.getItem('chats');
                if (savedChats) {
                    chats = JSON.parse(savedChats);
                    updateChatList();
                }
            }

            // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ä¿å­˜
            function saveChats() {
                localStorage.setItem('chats', JSON.stringify(chats));
            }

            function createNewChat() {
                const newChat = {
                    id: Date.now().toString(),
                    title: 'æ–°ã—ã„ãƒˆãƒ¼ã‚¯',
                    messages: [],
                    pinned: false,
                    bot: null,
                    conversation_id: null
                };
                
                chats.push(newChat);
                currentChatId = newChat.id;
                updateChatList();
                saveChats();
                openBotSelector();
            }

            function updateChatList() {
                const pinnedChats = document.getElementById('pinnedChats');
                const allChats = document.getElementById('allChats');
                
                pinnedChats.innerHTML = '';
                allChats.innerHTML = '';
                
                // ä½œæˆæ—¥æ™‚ã®æ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆ
                const sortedChats = [...chats].sort((a, b) => b.id - a.id);
                
                sortedChats.forEach(chat => {
                    const chatElement = createChatElement(chat);
                    if (chat.pinned) {
                        pinnedChats.appendChild(chatElement);
                    } else {
                        allChats.appendChild(chatElement);
                    }
                });
            }

            function createChatElement(chat) {
                const div = document.createElement('div');
                div.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="chat-title">${chat.title}</span>
                        <button onclick="showChatMenu(event, '${chat.id}')" class="chat-menu-button">
                            â€¢â€¢â€¢
                        </button>
                    </div>
                `;
                div.onclick = () => selectChat(chat.id);
                return div;
            }

            function selectChat(chatId) {
                currentChatId = chatId;
                const chat = chats.find(c => c.id === chatId);
                currentBot = chat.bot;
                updateChatList();
                displayMessages(chat.messages);
            }

            function displayMessages(messages) {
                const messagesDiv = document.getElementById('messages');
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´ ã‚’ä¸€æ™‚çš„ã«ä¿å­˜
                const loadingMessage = document.getElementById('loadingMessage');
                messagesDiv.innerHTML = '';
                
                messages.forEach(msg => {
                    messagesDiv.innerHTML += `
                        <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} mb-4">
                            <div class="${msg.role === 'user' ? 'bg-blue-500 text-white' : 'bg-gray-100'} rounded-lg px-4 py-2 max-w-[70%]">
                                ${msg.content}
                            </div>
                        </div>
                    `;
                });
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´ ã‚’å†è¿½åŠ 
                messagesDiv.appendChild(loadingMessage);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            function showChatMenu(event, chatId) {
                event.stopPropagation();
                const menu = document.getElementById('chatMenu');
                menu.classList.remove('hidden');
                menu.style.top = `${event.pageY}px`;
                menu.style.left = `${event.pageX}px`;
                currentChatId = chatId;
            }

            function editChatTitle() {
                const chat = chats.find(c => c.id === currentChatId);
                const newTitle = prompt('æ–°ã—ã„ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', chat.title);
                if (newTitle) {
                    chat.title = newTitle;
                    updateChatList();
                    saveChats();
                }
                document.getElementById('chatMenu').classList.add('hidden');
            }

            function togglePinChat() {
                const chat = chats.find(c => c.id === currentChatId);
                chat.pinned = !chat.pinned;
                updateChatList();
                saveChats();
                document.getElementById('chatMenu').classList.add('hidden');
            }

            function deleteChat() {
                if (confirm('ã“ã®ãƒˆãƒ¼ã‚¯ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                    chats = chats.filter(c => c.id !== currentChatId);
                    if (currentChatId === currentChatId) {
                        currentChatId = null;
                        currentBot = null;
                        document.getElementById('messages').innerHTML = '';
                    }
                    updateChatList();
                    saveChats();
                }
                document.getElementById('chatMenu').classList.add('hidden');
            }

            // ãƒœãƒƒãƒˆé¸æŠé–¢é€£
            function openBotSelector() {
                document.getElementById('botSelector').classList.remove('hidden');
            }

            function closeBotSelector() {
                document.getElementById('botSelector').classList.add('hidden');
            }

            function selectBot(botId) {
                const chat = chats.find(c => c.id === currentChatId);
                if (chat) {
                    chat.bot = botId;
                    currentBot = botId;
                    chat.messages.push({
                        role: 'assistant',
                        content: 'ã“ã‚“ã«ã¡ã¯ï¼ã©ã®ã‚ˆã†ãªãŠæ‰‹ä¼ã„ãŒã§ãã¾ã™ã‹ï¼Ÿ'
                    });
                    displayMessages(chat.messages);
                    saveChats();
                }
                closeBotSelector();
            }

            async function sendMessage() {
                if (!currentBot || !currentChatId) return;
                
                const input = document.getElementById('messageInput');
                const message = input.value.trim();
                if (!message) return;

                // å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨ˆç®—
                const inputTokens = calculateTokens(message);
                const remainingTokens = tokenManager.getRemainingTokens();

                if (inputTokens > remainingTokens) {
                    alert('ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™ã«é”ã—ã¾ã—ãŸ');
                    return;
                }

                // å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¶ˆè²»ï¼ˆé€ä¿¡æ™‚ï¼‰
                tokenManager.useTokens(inputTokens);

                const chat = chats.find(c => c.id === currentChatId);
                chat.messages.push({
                    role: 'user',
                    content: message
                });
                
                displayMessages(chat.messages);
                input.value = '';

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                const loadingMessage = document.getElementById('loadingMessage');
                loadingMessage.classList.remove('hidden');

                try {
                    const response = await fetch(`/chat/${currentBot}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            conversation_id: chat.conversation_id,
                            user_id: 'default_user'
                        })
                    });

                    const data = await response.json();
                    loadingMessage.classList.add('hidden');

                    // AIã®å¿œç­”ã‚’è¿½åŠ 
                    chat.messages.push({
                        role: 'assistant',
                        content: data.answer
                    });

                    // å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨ˆç®—ã—ã¦æ¶ˆè²»ï¼ˆå¿œç­”è¡¨ç¤ºæ™‚ï¼‰
                    const outputTokens = calculateTokens(data.answer);
                    tokenManager.useTokens(outputTokens);
                    
                    displayMessages(chat.messages);
                    saveChats();
                    
                } catch (error) {
                    console.error('Error:', error);
                    loadingMessage.classList.add('hidden');
                    
                    chat.messages.push({
                        role: 'error',
                        content: error.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚'
                    });
                    displayMessages(chat.messages);
                }
            }

            // ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
            function calculateTokens(text) {
                // æ—¥æœ¬èªæ–‡å­—ï¼ˆæ¼¢å­—ã€ã²ã‚‰ãŒãªã€ã‚«ã‚¿ã‚«ãƒŠï¼‰ã‚’æ¤œå‡º
                const japaneseChars = (text.match(/[\u3000-\u303f\u3040-\u309f\u30a0-\u30ff\u4e00-\u9faf\u3400-\u4dbf]/g) || []).length;
                // è‹±æ•°å­—ã¨è¨˜å·
                const otherChars = (text.match(/[a-zA-Z0-9\s\W]/g) || []).length;
                
                // æ—¥æœ¬èªã¯1æ–‡å­—2.5ãƒˆãƒ¼ã‚¯ãƒ³ã€ãã®ä»–ã¯1æ–‡å­—0.5ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã—ã¦è¨ˆç®—
                const totalTokens = Math.ceil(japaneseChars * 2.5 + otherChars * 0.5);
                return Math.max(1, totalTokens);  // æœ€ä½1ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿è¨¼
            }

            // Shift + Enterã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // ã‚¯ãƒªãƒƒã‚¯ä»¥å¤–ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('chatMenu');
                if (!menu.contains(e.target) && !e.target.classList.contains('chat-menu-button')) {
                    menu.classList.add('hidden');
                }
            });

            // ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰
            function resetTokens() {
                updateRemainingTokens(2000);
            }

            function updateRemainingTokens(tokens) {
                remainingTokens = tokens;
                document.getElementById('remainingTokens').textContent = tokens;
            }

            // åˆæœŸè¡¨ç¤ºæ™‚ã®å‡¦ç†ã ã‘ã‚’è¿½åŠ 
            document.addEventListener('DOMContentLoaded', () => {
                loadChats();
                
                if (chats.length === 0) {
                    // ãƒˆãƒ¼ã‚¯ãŒ1ã¤ã‚‚ãªã„å ´åˆã¯ã€ãƒœãƒƒãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                    openBotSelector();
                } else {
                    // æœ€æ–°ã®ãƒˆãƒ¼ã‚¯ã‚’é¸æŠï¼ˆé…åˆ—ã®æœ€å¾Œã®è¦ç´ ï¼‰
                    const latestChat = chats[chats.length - 1];
                    currentChatId = latestChat.id;
                    currentBot = latestChat.bot;
                    
                    // æœ€æ–°ã®ãƒˆãƒ¼ã‚¯ã‚’è¡¨ç¤º
                    displayMessages(latestChat.messages);
                    
                    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ãƒˆãƒ¼ã‚¯ä¸€è¦§ã‚’æ›´æ–°
                    updateChatList();
                }
            });
        </script>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºç”¨ã®CSS -->
        <style>
            .typing-indicator {
                display: flex;
                gap: 4px;
            }

            .typing-indicator span {
                width: 8px;
                height: 8px;
                background-color: #9CA3AF;
                border-radius: 50%;
                animation: bounce 1.4s infinite ease-in-out;
            }

            .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
            .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

            @keyframes bounce {
                0%, 80%, 100% { transform: scale(0); }
                40% { transform: scale(1); }
            }
        </style>
    </body>
</html>
